<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>cnpmjs, 国产npm的逆袭</title>

    <meta name="description" content="An introduction for cnpmjs.org.">
    <meta name="author" content="dead_horse">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="../reveal.js/css/reveal.min.css">
    <link rel="stylesheet" href="../styles/reveal_theme.css" id="theme">
    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="../styles/github.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="../reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
            <a href="http://cnpmjs.org" target="_blank"><img src="https://i.alipayobjects.com/e/201312/1hpHUxAPRN.png"></a>
            <h3>国产 NPM 的逆袭</h3>
        </section>
        <section>
          <p><a href="http://deadhorse.me" target="_blank"><img src=" https://i.alipayobjects.com/e/201312/1hqKEPJPlt.jpeg" class="mug"></a></p>
          <small><a href="http://github.com/dead-horse" target="_blank">dead-horse @ github</a></small><br />
          <small><a href="http://weibo.com/deadhorse" target="_blank">2B码农死小马 @ weibo</a></small><br />
          <small>不四 @ <a href="https://github.com/TBEDP" target="_blank">阿里巴巴数据产品部</a> | Focus on Web and <a href="http://nodejs.org" target="_blank">Node.js</a></small><br />
        </section>
        <section data-background="#c66">
          <a href="https://scalenpm.org/" target="_blank"><img src="https://i.alipayobjects.com/e/201312/1hqF6h3AVZ.png"></a>
        </section>
        <section data-background="#c66">
          <h2 class="weiss">270,000 $ ? WTF !</h2>
        </section>
        <section data-background="#c66">
          <a href="http://blog.nodejs.org/2013/11/26/npm-post-mortem/" target="_blank"><img src="https://i.alipayobjects.com/e/201312/1hqdO6gF6D.png"></a>
        </section>
        <section data-background="#c66">
          <h2 class="weiss">npm 要如何优化？</h2>
        </section>
        <section data-background="#c66">
          <ol>
            <li class="weiss">Always be in multi-master</li>
            <li class="fragment weiss" data-fragment-index="0">Decouple www.npmjs.org and registry.npmjs.org</li>
            <li class="fragment weiss" data-fragment-index="1">Always have a spare replica</li>
            <li class="fragment weiss" data-fragment-index="2">Move attachments out of CouchDB</li>
          </lo>
        </section>
        <section data-background="#c66">
          <ol>
            <li class="weiss">不熟悉 CouchDB</li>
            <li class="fragment weiss" data-fragment-index="0">新的 npm 架构 Isaacs 还没想好</li>
            <li class="fragment weiss" data-fragment-index="1">模块的 tgz 包需要单独存储</li>
            <li class="fragment weiss" data-fragment-index="2">我们没有 270,000 $</li>
          </lo>
        </section>
        <section data-background="">
          <h3>有没有更容易的办法来做这件事情？</h3>
        </section>
        <section data-background="" data-transition="fade">
          <p><img src="https://i.alipayobjects.com/e/201312/1hrFVHX2Pl.png" height="80"></p>
          <p><img height="80"></p>
        </section>
        <section data-background="" data-transition="none">
          <p><img src="https://i.alipayobjects.com/e/201312/1hrFVHX2Pl.png" height="80" style="opacity:0.2;"></p>
          <P><img src="http://dev.mysql.com/common/logos/logo-mysql-110x57.png" height="80" style="margin-right:20px;">  <img src="https://i.alipayobjects.com/e/201312/1hrNU9a1iP.png" height="80" style="margin-left:20px;"></P>
        </section>
        <section data-transition="fade">
          <h4>保持 npm 的所有接口</h4>
          <img src="https://i.alipayobjects.com/e/201312/1idmp3dnJd.png">
        </section>
        <section data-transition="none">
          <h4 class="normal-case">MySQL + CDN 重新实现</h4>
          <img src="https://i.alipayobjects.com/e/201312/1idszqfxsb.png">
        </section>
        <section data-transition="none">
          <h4>可扩展</h4>
          <img src="https://i.alipayobjects.com/e/201312/1idssRVRUb.png">
        </section>
        <section>
          <a href="http://cnpmjs.org" target="_blank"><img src="https://i.alipayobjects.com/e/201312/1iWgWF8yMP.png"></a>
        </section>
        <section data-background="#a3e2c3">
          <h3>完全同步的 NPM 镜像</h3>
        </section>
        <section data-transition="fade">
          <h4>NPM</h4>
          <img src="https://i.alipayobjects.com/e/201312/1idq6IK8Y9.png">
        </section>
        <section data-transition="none">
          <h4>CNPM</h4>
          <img src="https://i.alipayobjects.com/e/201312/1idwUmeipB.png">
        </section>
        <section>
          <h3>同步方式</h3>
          <ul>
            <li class="fragment" data-fragment-id="0">每30分钟自动增量同步</li>
            <li class="fragment" data-fragment-id="1">cnpm sync 主动同步</li>
            <li class="fragment" data-fragment-id="2">cnpm install 安装不存在的模块或版本，自动同步</li>
            <li class="fragment" data-fragment-id="3">通过 <a href="http://cnpmjs.org" target="_blank">web</a> 主动同步</li>
          </ul>
        </section>
        <section id="cnpm-info">
          <h4>cnpm 现状</h4>
          <ul>
            <li><span class="orange" id="total-packages"></span> total packages</li>
            <li><span class="orange" id="total-versions"></span> total package versions</li>
            <li><span class="orange" id="download-week"></span> downloads in this week</li>
            <li><span class="orange" id="download-month"></span> downloads in this month</li>
            <li>Last sync time: <span class="orange" id="last-sync-time"></span></li>
            <li><span class="orange" id="sync-suceess"></span> packages sync successed last time.</li>
          </ul>
        </section>        
        <section data-markdown>
          ### 如何使用

          ```
          # 安装 cnpm
          $ npm install -g cnpm
          # 或者 alias npm
          $ alias cnpm="npm --registry=http://registry.cnpmjs.org \
          --cache=${HOME}/.npm/.cache/cnpm \
          --userconfig=${HOME}/.cnpmrc"

          # 开始从cnpm 安装依赖
          $ cnpm install connect
          
          # 如果发现cnpm没有同步到最新版本，可以手动触发同步
          $ cnpm sync connect

          # 不允许直接发布到cnpm
          $ npm publish name
          $ cnpm sync name
          ```
        </section>
        <section data-background="#c66">
          <h3 class="weiss">请勿</h3>
          <pre><code>
          # 修改 ~/.npmrc, 添加
          registry = http://registry.cnpmjs.org
          # 或者使用 npm config
          $ npm config set registry http://registry.cnpmjs.org
          </code></pre>
        </section>
        <section>
          <h3>回馈社区</h3>
          <pre><code>
            # 多pubish 到官方源
            $ npm adduser
            $ npm publish
          </code></pre>          
        </section>   
        <section data-background="#a3e2c3" data-transition="fade">
          <h4>不只是一个 npm 的镜像</h4>
          <h3 class="fragment" data-fragment-id="0">更是一个企业级npm解决方案</h3>
        </section>
        <section data-transition="fade">
          <h4>CNPM</h4>
          <img src="https://i.alipayobjects.com/e/201312/1idwUmeipB.png">
        </section>        
        <section data-transition="none">
          <h4 class="normal-case">CNPM with Admin</h4>
          <img src="https://i.alipayobjects.com/e/201312/1idqMTBBuv.png">
        </section>
        <section data-transition="none">
          <h4 class="normal-case">CNPM with Admin</h4>
          <img src="https://i.alipayobjects.com/e/201312/1idwl2PTHB.png">
        </section>
        <section>
          <h3>同步方式</h3>
          <ul>
            <li class="fragment" data-fragment-id="0">每30分钟自动更新库中模块版本</li>
            <li class="fragment" data-fragment-id="1">cnpm sync 主动同步</li>
            <li class="fragment" data-fragment-id="2">cnpm install 安装不存在的模块或版本，自动同步</li>
            <li class="fragment" data-fragment-id="3">通过 <a href="http://cnpmjs.org" target="_blank">web</a> 主动同步</li>
          </ul>
        </section>        
        <section>
          <h3>3分钟完成部署</h3>
        </section>
        <section data-markdown>
          ### 依赖
          * Node
          * Mysql  
          * Redis  
          * qiniu CDN (或者其他私有CDN)  
        </section>
        <section>
          <h2 class="normal-case">Goodbye, CouchDB !</h2>
        </section>        
        <section data-markdown>
          ### 获取代码
          ```
          # clone from github
          $ git clone git://github.com/fengmk2/cnpmjs.org.git $HOME/cnpmjs.org
          $ cd $HOME/cnpmjs.org

          # create mysql tables
          $ mysql -u yourname -p
          mysql> use cnpmjs;
          mysql> source docs/db.sql

          # create your own config file
          $ vim config/config.js
          ```
        </section>
        <section>
          <h3 class="normal-case">config file</h3>

          <pre><code class="javascript">
  module.exports = {
    debug: false,
    enableCluster: true, // enable cluster mode
    mysqlServers: [
      {
        host: 'localhost',
        port: 3306,
        user: 'cnpmjs',
        password: 'cnpmjs123',
      }
    ],
    mysqlDatabase: 'cnpmjstest',
    redis: {
      host: 'localhost',
      port: 6379,
    },
    nfs: null, //use your own CND here
    enablePrivate: true, // enable private mode, only admin can publish, other use just can sync package from source npm
    admins: {
      admin: 'admin@cnpmjs.org',
    },
    syncModel: 'exist'
  };  
          </code></pre>
        </section>
        <section data-markdown>
          #### 安装依赖
          ```
          make install
          ```
          #### 启动 
          ```
          $ npm run start

          Starting cnpmjs.org ...
          Start nodejs success. PID=27175
          ```
          #### 查看服务
          ```bash
          #open registry and web
          # registry
          open http://localhost:7001
          # web
          open http://localhost:7002          
          ```
        </section>
        <section data-markdown>
          #### 使用cnpm作为私有库的客户端
          ```bash
          # install cnpm first
          npm install -g cnpm 

          # then alias lnpm to cnpm, but change config to your own registry
          alias lnpm='cnpm --registry=http://localhost:7001\
           --registryweb=http://localhost:7002\
           --cache=$HOME/.npm/.cache/lnpm\
           --userconfig=$HOME/.lnpmrc'

           #or put this in .zshrc or .bashrc
           echo "#lnpm alias\nalias lnpm='cnpm --registry=http://localhost:7001\
           --registryweb=http://localhost:7002\
           --cache=$HOME/.npm/.cache/lnpm\
           --userconfig=$HOME/.lnpmrc'" >> $HOME/.zshrc && source $HOME/.zshrc
          ```
        </section>
        <section>
          <h2 class="normal-case">Do It Now!</h2>
        </section>
        <section>
          <div style="position:absolute; top:35%; left:0; right:0;">
            <h2 style="text-align: center;">Q & A</h2>
            <br />
            <br />
            <h3 style="position: absolute; right:150px">thanks</h3>
          </div>          
        </section>
      </div>
    </div>

    <script src="../reveal.js/lib/js/head.min.js"></script>
    <script src="../reveal.js/js/reveal.min.js"></script>
    <script src="http://cdn.staticfile.org/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://cdn.staticfile.org/moment.js/2.4.0/moment.min.js"></script>
    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel../reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        keyboard: true,
        rollingLinks: true,
        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'concave', // default/cube/page/concave/zoom/linear/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: '../reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '../reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
        ]
      });

      function humanize(n, options) {
        options = options || {};
        var d = options.delimiter || ',';
        var s = options.separator || '.';
        n = n.toString().split('.');
        n[0] = n[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + d);
        return n.join(s);
      }      
      $.getJSON('http://registry.cnpmjs.org/?callback=?', function (data) {
        $('#total-packages').html(humanize(data.doc_count));
        $('#total-versions').html(humanize(data.doc_version_count));
        $('#download-week').html(humanize(data.download.thisweek));
        $('#download-month').html(humanize(data.download.thismonth));
        $('#last-sync-time').html(moment(data.last_sync_time).format('YYYY-MM-DD HH:mm:ss'));
        $('#sync-suceess').html(data.success_sync_num);
      });
    </script>
  </body>
</html>
